<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>Comparison of clusterProfiler and GSEA-P</title>

  
  <link rel="stylesheet" href="http://guangchuangyu.github.io/css/hugo-octopress.css">

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://guangchuangyu.github.io/favicon.png" rel="icon">

  
  
  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Guangchuang Yu">

  
  <meta name="generator" content="Hugo 0.15" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://guangchuangyu.github.io/">Guangchuang Yu</a></h1>
    <h2>a senior-in-age-but-not-senior-in-knowledge bioinformatician</h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
  
    
      <li><a href="http://guangchuangyu.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="http://guangchuangyu.github.io/resume" target="_blank" title="Resume">Resume</a></li>
    
  
    
      <li><a href="http://guangchuangyu.github.io/douban" target="_blank" title="Douban">Douban</a></li>
    
  
    
      <li><a href="http://guangchuangyu.github.io/archive" target="_blank" title="Archive">Archive</a></li>
    
  
</ul>


<ul class="subscription">
  <a href="http://guangchuangyu.github.io/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>

  
  

</ul>


</nav>



<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            Comparison of clusterProfiler and GSEA-P 
          </h1>
          <p class="meta">Nov 2, 2015 - 5 minute read -  <a href="http://guangchuangyu.github.io/2015/11/comparison-of-clusterprofiler-and-gsea-p/#disqus_thread">Comments</a>

          

          
          
          <a class="label" href="http://guangchuangyu.github.io/categories/r">R</a>
          </p>
        </header>
        <div class="entry-content">
<span class='st_twitter_hcount' displayText='Tweet'></span>
<span class='st_facebook_hcount' displayText='Facebook'></span>
<span class='st_sina_hcount' displayText='Sina'></span>
<span class='st_linkedin_hcount' displayText='LinkedIn'></span>
          

<p>Thanks <a href="https://github.com/mevers">@mevers</a> for raising <a href="https://github.com/GuangchuangYu/clusterProfiler/issues/31">the issue</a> to me
and his efforts in benchmarking
<a href="https://github.com/GuangchuangYu/clusterProfiler">clusterProfiler</a>.</p>

<p>He pointed out two issues:</p>

<ul>
<li>outputs from gseGO and GSEA-P are poorly overlap.</li>
<li>pvalues from gseGO are generally smaller and don&rsquo;t show a lot of
variation</li>
</ul>

<p>For GSEA analysis, we have two inputs, a ranked gene list and gene set
collections.</p>

<p>First of all, the gene set collections are very different. The GMT file
used in his test is <em>c5.cc.v5.0.symbols.gmt</em>, which is a tiny subset of
GO CC, while clusterProfiler used the whole GO CC corpus.</p>

<p>For instance, with his gene list as input, clusterProfiler annotates 195
genes as ribosome, while GSEA-P (using c5.cc.v5.0.symbols.gmt) only
annotates 38 genes.</p>

<p>As the gene set collections is so different, I don&rsquo;t believe the
comparison can produce any valuable results.</p>

<p>The first step should be extending clusterProfiler to support using GMT
file as gene set annotation, thereafter we can use identical input (both
gene list and gene sets) and then benchmarking will be valuable for
detecting issues that exclusively attributed to the implementation of
GSEA algorithm.</p>

<h3 id="clusterprofiler-supports-gmt-file:140b254f6d6e22f5c796e058ac8120af">clusterProfiler supports GMT file</h3>

<p>Currently clusterProfiler supports <a href="http://guangchuangyu.github.io/2015/05/use-clusterprofiler-as-an-universal-enrichment-analysis-tool/">user&rsquo;s own annotations</a>
via <em>enricher</em> and <em>GSEA</em> functions which require users provide their
own annotation in a <em>data.frame</em>. This is a general interface for using
user&rsquo;s own annotation.</p>

<p>To support GMT file, we only need a function, <em>read.gmt</em>, to parse GMT
file and output a <em>data.frame</em> that is suitable for <em>enricher</em> and
<em>GSEA</em>. Now this function is available in devel branch (in BioC 3.3 or
<a href="https://github.com/GuangchuangYu/clusterProfiler">github</a>) of
clusterProfiler.</p>

<p>As <a href="https://github.com/mevers">@mevers</a> used <em>c5.cc</em>, I also use it for
further comparison. I have packed the file into clusterProfiler, so that
users can use it for testing/practice.</p>

<pre><code>&gt; gmtfile &lt;- system.file(&quot;extdata&quot;, &quot;c5.cc.v5.0.entrez.gmt&quot;, 
                         package=&quot;clusterProfiler&quot;)
## only 207K.
## It's indeed a tiny subset of CC.
&gt; file.size(gmtfile)/1000
[1] 207.608
&gt; c5 &lt;- read.gmt(gmtfile)
</code></pre>

<h4 id="hypergeometric-test-with-gmt-annotation:140b254f6d6e22f5c796e058ac8120af">hypergeometric test with GMT annotation</h4>

<pre><code>&gt; require(clusterProfiler)
&gt; data(geneList, package=&quot;DOSE&quot;)
&gt; de &lt;- names(geneList)[abs(geneList) &gt; 2]
&gt; head(de)
[1] &quot;4312&quot;  &quot;8318&quot;  &quot;10874&quot; &quot;55143&quot; &quot;55388&quot; &quot;991&quot;  
&gt; x &lt;- enricher(de, TERM2GENE=c5)
## omit some columns to make it more readable
&gt; head(summary(x)[, c(1, 3:7)], 3)
                                               ID GeneRatio  BgRatio
SPINDLE                                   SPINDLE     11/82  39/5270
MICROTUBULE_CYTOSKELETON MICROTUBULE_CYTOSKELETON     16/82 152/5270
CYTOSKELETAL_PART               CYTOSKELETAL_PART     15/82 235/5270
                               pvalue     p.adjust       qvalue
SPINDLE                  7.667674e-12 6.594200e-10 5.327016e-10
MICROTUBULE_CYTOSKELETON 8.449298e-10 3.633198e-08 2.935019e-08
CYTOSKELETAL_PART        2.414879e-06 6.623386e-05 5.350593e-05
</code></pre>

<h4 id="gene-set-enrichment-analysis-with-gmt-annotation:140b254f6d6e22f5c796e058ac8120af">gene set enrichment analysis with GMT annotation</h4>

<pre><code>&gt; y &lt;- GSEA(geneList, TERM2GENE=c5)
&gt; head(summary(y)[, -c(1,2)], 2)
                          setSize enrichmentScore       NES      pvalue
EXTRACELLULAR_REGION          401      -0.3860230 -1.694322 0.001237624
EXTRACELLULAR_REGION_PART     310      -0.4101043 -1.765775 0.001269036
                            p.adjust    qvalues
EXTRACELLULAR_REGION      0.03047874 0.02316228
EXTRACELLULAR_REGION_PART 0.03047874 0.02316228
</code></pre>

<h3 id="comparison-of-clusterprofiler-and-gsea-p:140b254f6d6e22f5c796e058ac8120af">Comparison of clusterProfiler and GSEA-P</h3>

<p>Now with <em>read.gmt</em>, we can compare clusterProfiler and GSEA-P with the
same input.</p>

<p>First of all, I export <em>geneList</em> to a <em>rnk</em> file.</p>

<pre><code>data(geneList, package=&quot;DOSE&quot;)
d=data.frame(gene=names(geneList), FC=geneList)
write.table(d, row.names=F,col.names=F, quote=F, file=&quot;geneList.rnk&quot;, sep=&quot;\t&quot;)
</code></pre>

<p>And run GSEA-P with the following parameters:</p>

<pre><code>producer_class  xtools.gsea.GseaPreranked
producer_timestamp  1445941169480
param   collapse    false
param   plot_top_x  20
param   rnk /Users/guangchuangyu/Downloads/geneList.rnk
param   norm    meandiv
param   scoring_scheme  weighted
param   make_sets   true
param   mode    Max_probe
param   gmx /Users/guangchuangyu/Downloads/c5.cc.v5.0.entrez.gmt
param   gui false
param   rpt_label   my_analysis
param   help    false
param   out /Users/guangchuangyu/gsea_home/output/oct27
param   include_only_symbols    true
param   set_min 15
param   nperm   1000
param   rnd_seed    timestamp
param   zip_report  false
param   set_max 500
</code></pre>

<p>Re-run clusterProfiler::GSEA with pvalueCutoff=1.</p>

<pre><code>g &lt;- read.delim(&quot;gsea_report_for_na_neg_1445941169480.xls&quot;)
xx &lt;- GSEA(geneList, TERM2GENE=c5, nPerm=1000, pvalueCutoff=1)
gy = merge(g, summary(xx), by.x=&quot;NAME&quot;, by.y=&quot;ID&quot;)
ggplot(gy, aes(NOM.p.val, pvalue)) + geom_point() + xlim(0, 1) + ylim(0, 1)
</code></pre>

<p><img src="https://cloud.githubusercontent.com/assets/626539/10757414/e8d4f490-7ce5-11e5-9027-1dbe81e66329.png" alt="" /></p>

<p>Now the comparison tells! clusterProfiler indeed produce smaller
pvalues. As I said in <a href="http://guangchuangyu.github.io/2014/08/why-clusterprofiler-fails/">why clusterProfiler fails</a>, in
general software produce more conservative result is more trustable.
This is indeed an issue I couldn&rsquo;t omit.</p>

<p>This issue is attributed to DOSE package, which serves as a backend of
both clusterProfiler and ReactomePA.</p>

<p>In DOSE, we calculate the pvalue in the following way:</p>

<blockquote>
<p>For each geneList, we calculate the observed ES, and then perform
permutation to generate a null ES distribution. pvalue = (sum(ES &gt;=
permES)+1)/(nPerm+1), for greater side as an example, is calculated.</p>
</blockquote>

<h3 id="fixed-bug-of-dose:140b254f6d6e22f5c796e058ac8120af">fixed bug of DOSE</h3>

<p>Eventually I figured out that the way we calculate pvalue is not
correct. As presented in
<a href="http://www.pnas.org/content/102/43/15545.abstract">Subramaniam</a> <em>et
al</em>, the distribution of ES is bimodal. Positive and negative ES values
should be separated when calculating pvalues.</p>

<p>After I changed the <a href="https://github.com/GuangchuangYu/DOSE/commit/12a35b7ff31d3dfd51d81d0f6a6e1afaa24a9823">source code</a>,
the pvalues generated by clusterProfiler::GSEA and GSEA-P are almost
identical.</p>

<p><img src="https://cloud.githubusercontent.com/assets/626539/10787607/34fd8716-7dad-11e5-9f43-6433b574b77b.png" alt="" /></p>

<p>This bug was fixed in both release (&gt;=2.8.1) and devel (&gt;=2.9.1)
branches. The fixed will affect DOSE, clusterProfiler and ReactomePA.</p>

<h3 id="other-concerns:140b254f6d6e22f5c796e058ac8120af">other concerns</h3>

<p>There are other differences between clusterProfiler and GSEA-P.</p>

<h4 id="clusterprofiler-never-produce-pvalue-0:140b254f6d6e22f5c796e058ac8120af">clusterProfiler never produce pvalue=0</h4>

<p>For calculating pvalues, GSEA-P may produce pvalue=0, while
clusterProfiler never produce pvalue=0 since we add pseudocount, 1, in
both numerator and demoninator. Some software may not accept pvalue=0,
for example if you want to use topGO to visualize enrichment with GO
topology, the result can&rsquo;t contain any pvalue=0.</p>

<h4 id="clusterprofiler-test-whole-gene-set-collections:140b254f6d6e22f5c796e058ac8120af">clusterProfiler test whole gene set collections</h4>

<pre><code>&gt; g=read.delim(&quot;gsea_report_for_na_neg_1445941169480.xls&quot;)
&gt; dim(g)
[1] 56 12
&gt; yy = summary(xx)
&gt; yy = yy[with(yy, setSize &gt;= 15 &amp; setSize &lt;=500),]
&gt; dim(yy)
[1] 152   8
&gt; all(g$NAME %in% yy$ID)
[1] TRUE
</code></pre>

<p>GSEA-P didn&rsquo;t filter result by pvalues, as it reported pvalues ranging
from 0 to 1.</p>

<p>We cut our result by setSize in $[15, 500]$ as default parameter of
GSEA-P.</p>

<p>clusterProfiler tests all the gene sets while GSEA-P only tests a
subset.</p>

<p>If I have some free time, I will figure out how they select gene sets to
test. If it&rsquo;s reasonable, we can add a parameter for clusterProfiler
users to switch between two modes (full sets or subset). This is still
an open issue/question. If you have any idea, don&rsquo;t hesitate to let me
know. :)</p>

<span class='st_twitter_hcount' displayText='Tweet'></span>
<span class='st_facebook_hcount' displayText='Facebook'></span>
<span class='st_sina_hcount' displayText='Sina'></span>
<span class='st_linkedin_hcount' displayText='LinkedIn'></span>
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Guangchuang Yu</span></span>
    
    <time>Nov 2, 2015</time>
    <span class="categories">
      Tags: 
        
        
          <a class="category" href="http://guangchuangyu.github.io/tags/clusterprofiler">clusterProfiler</a>  
        
    </span>
  </p>
    
  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://guangchuangyu.github.io/2015/10/use-simplify-to-remove-redundancy-of-enriched-go-terms/" title="use simplify to remove redundancy of enriched GO terms">use simplify to remove redundancy of enriched GO terms</a>
    

     
      <a class="basic-alignment right" href="http://guangchuangyu.github.io/2015/11/%E5%90%88%E4%BD%93%E4%B8%AD%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="合体中的操作系统">合体中的操作系统</a>
    
  </p>

  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'gcyu';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

 

	</article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">
    
    <h1>Who am I</h1>
    
    
    <p>I am Guangchuang YU. A PhD candidate studying evolution of influenza A virus at The University of Hong Kong.
      <br><br>View my profile in <a href="https://scholar.google.com.hk/citations?user=DO5oG40AAAAJ&hl=en">Google Scholar</a> and <a href="https://www.researchgate.net/profile/Guangchuang_Yu">ResearchGate</a>.
    </p>

    
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
    <a target="_blank" href="https://github.com/GuangchuangYu" title="https://github.com/GuangchuangYu"><i class="fa fa-github fa-3x"></i></a>
    <a target="_blank" href="https://www.linkedin.com/in/guangchuang-yu-86820120" title="https://www.linkedin.com/in/guangchuang-yu-86820120"><i class="fa fa-linkedin fa-3x"></i></a>
    <a target="_blank" href="https://www.facebook.com/guangchuang.yu" title="https://www.facebook.com/guangchuang.yu"><i class="fa fa-facebook fa-3x"></i></a>
    <a target="_blank" href="https://twitter.com/guangchuangyu" title="https://twitter.com/guangchuangyu"><i class="fa fa-twitter fa-3x"></i></a>
    <a target="_blank" href="http://www.weibo.com/uncleyy" title="http://www.weibo.com/uncleyy"><i class="fa fa-weibo fa-3x"></i></a>

    
    
    
    
    </li>
  </ul>

 
  
  
  <section class="even">
    <h1>Recent Posts</h1>

    
    <ul id="recent_posts">
      
      
        
      
      
      <li class="post">
        <a href="/2016/03/%E4%BD%BF%E7%94%A8ggtree%E5%AE%9E%E7%8E%B0%E8%BF%9B%E5%8C%96%E6%A0%91%E7%9A%84%E5%8F%AF%E8%A7%86%E5%8C%96%E5%92%8C%E6%B3%A8%E9%87%8A/">使用ggtree实现进化树的可视化和注释</a>
      </li>
      
      <li class="post">
        <a href="/2016/02/covplot-supports-grangeslist/">covplot supports GRangesList</a>
      </li>
      
      <li class="post">
        <a href="/2016/02/tweets-of-ggtree/">tweets of ggtree</a>
      </li>
      
      <li class="post">
        <a href="/2016/02/reactomepa-an-r/bioconductor-package-for-reactome-pathway-analysis-and-visualization/">ReactomePA: an R/Bioconductor package for reactome pathway analysis and visualization</a>
      </li>
      
      <li class="post">
        <a href="/2016/01/ggtree-supports-phylip-tree-format/">ggtree supports phylip tree format</a>
      </li>
      
    </ul>
  </section>

  <section class="even">
    <h1>Book to Read</h1>
    Analysis of Phylogenetic and Evolution with R<br>
    Inferring phylogenies<br>
    Statistical Models: Theory and Practice<br>
    Algorithms on Strings, Trees, and Sequences
    <h1>Links</h1>
    <a href="http://www.biostathandbook.com/">Handbook of Biological Statistics</a><br>
    <a href="http://r-bloggers.com/">R-bloggers</a>
    <h1>友邻</h1>
    <a href="http://azaleasays.com/">azalea</a><br>
    <a href="http://blog.shenwei.me/">shenwei</a><br>
    <a href="http://ztpala.com/">ztpala</a>
  </section>

  <img src="http://guangchuangyu.github.io/blog_images/wechatpay.jpg" />
  
</aside>

  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Guangchuang Yu - <a href="http://guangchuangyu.github.io/license/">License</a> - 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/zenburn.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "d135f460-3fc5-4802-8169-bd08e4734a09", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>



</body>
</html>


